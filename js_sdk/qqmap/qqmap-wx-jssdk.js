var ERROR_CONF={KEY_ERR:311,KEY_ERR_MSG:"key\u683C\u5F0F\u9519\u8BEF",PARAM_ERR:310,PARAM_ERR_MSG:"\u8BF7\u6C42\u53C2\u6570\u4FE1\u606F\u6709\u8BEF",SYSTEM_ERR:600,SYSTEM_ERR_MSG:"\u7CFB\u7EDF\u9519\u8BEF",WX_ERR_CODE:1e3,WX_OK_CODE:200},BASE_URL="https://apis.map.qq.com/ws/",URL_SEARCH=BASE_URL+"place/v1/search",URL_SUGGESTION=BASE_URL+"place/v1/suggestion",URL_GET_GEOCODER=BASE_URL+"geocoder/v1/",URL_CITY_LIST=BASE_URL+"district/v1/list",URL_AREA_LIST=BASE_URL+"district/v1/getchildren",URL_DISTANCE=BASE_URL+"distance/v1/",URL_DIRECTION=BASE_URL+"direction/v1/",MODE={driving:"driving",transit:"transit"},EARTH_RADIUS=6378136.49,Utils={safeAdd(a,b){var c=(65535&a)+(65535&b);return(a>>16)+(b>>16)+(c>>16)<<16|65535&c},bitRotateLeft(a,b){return a<<b|a>>>32-b},md5cmn(c,d,a,b,e,f){return this.safeAdd(this.bitRotateLeft(this.safeAdd(this.safeAdd(d,c),this.safeAdd(b,f)),e),a)},md5ff(e,a,b,c,d,f,g){return this.md5cmn(a&b|~a&c,e,a,d,f,g)},md5gg(e,a,b,c,d,f,g){return this.md5cmn(a&c|b&~c,e,a,d,f,g)},md5hh(e,a,b,c,d,f,g){return this.md5cmn(a^b^c,e,a,d,f,g)},md5ii(e,a,b,c,d,f,g){return this.md5cmn(b^(a|~c),e,a,d,f,g)},binlMD5(e,f){e[f>>5]|=128<<f%32,e[(f+64>>>9<<4)+14]=f;var g,h,j,k,l,m=1732584193,n=-271733879,o=-1732584194,p=271733878;for(g=0;g<e.length;g+=16)h=m,j=n,k=o,l=p,m=this.md5ff(m,n,o,p,e[g],7,-680876936),p=this.md5ff(p,m,n,o,e[g+1],12,-389564586),o=this.md5ff(o,p,m,n,e[g+2],17,606105819),n=this.md5ff(n,o,p,m,e[g+3],22,-1044525330),m=this.md5ff(m,n,o,p,e[g+4],7,-176418897),p=this.md5ff(p,m,n,o,e[g+5],12,1200080426),o=this.md5ff(o,p,m,n,e[g+6],17,-1473231341),n=this.md5ff(n,o,p,m,e[g+7],22,-45705983),m=this.md5ff(m,n,o,p,e[g+8],7,1770035416),p=this.md5ff(p,m,n,o,e[g+9],12,-1958414417),o=this.md5ff(o,p,m,n,e[g+10],17,-42063),n=this.md5ff(n,o,p,m,e[g+11],22,-1990404162),m=this.md5ff(m,n,o,p,e[g+12],7,1804603682),p=this.md5ff(p,m,n,o,e[g+13],12,-40341101),o=this.md5ff(o,p,m,n,e[g+14],17,-1502002290),n=this.md5ff(n,o,p,m,e[g+15],22,1236535329),m=this.md5gg(m,n,o,p,e[g+1],5,-165796510),p=this.md5gg(p,m,n,o,e[g+6],9,-1069501632),o=this.md5gg(o,p,m,n,e[g+11],14,643717713),n=this.md5gg(n,o,p,m,e[g],20,-373897302),m=this.md5gg(m,n,o,p,e[g+5],5,-701558691),p=this.md5gg(p,m,n,o,e[g+10],9,38016083),o=this.md5gg(o,p,m,n,e[g+15],14,-660478335),n=this.md5gg(n,o,p,m,e[g+4],20,-405537848),m=this.md5gg(m,n,o,p,e[g+9],5,568446438),p=this.md5gg(p,m,n,o,e[g+14],9,-1019803690),o=this.md5gg(o,p,m,n,e[g+3],14,-187363961),n=this.md5gg(n,o,p,m,e[g+8],20,1163531501),m=this.md5gg(m,n,o,p,e[g+13],5,-1444681467),p=this.md5gg(p,m,n,o,e[g+2],9,-51403784),o=this.md5gg(o,p,m,n,e[g+7],14,1735328473),n=this.md5gg(n,o,p,m,e[g+12],20,-1926607734),m=this.md5hh(m,n,o,p,e[g+5],4,-378558),p=this.md5hh(p,m,n,o,e[g+8],11,-2022574463),o=this.md5hh(o,p,m,n,e[g+11],16,1839030562),n=this.md5hh(n,o,p,m,e[g+14],23,-35309556),m=this.md5hh(m,n,o,p,e[g+1],4,-1530992060),p=this.md5hh(p,m,n,o,e[g+4],11,1272893353),o=this.md5hh(o,p,m,n,e[g+7],16,-155497632),n=this.md5hh(n,o,p,m,e[g+10],23,-1094730640),m=this.md5hh(m,n,o,p,e[g+13],4,681279174),p=this.md5hh(p,m,n,o,e[g],11,-358537222),o=this.md5hh(o,p,m,n,e[g+3],16,-722521979),n=this.md5hh(n,o,p,m,e[g+6],23,76029189),m=this.md5hh(m,n,o,p,e[g+9],4,-640364487),p=this.md5hh(p,m,n,o,e[g+12],11,-421815835),o=this.md5hh(o,p,m,n,e[g+15],16,530742520),n=this.md5hh(n,o,p,m,e[g+2],23,-995338651),m=this.md5ii(m,n,o,p,e[g],6,-198630844),p=this.md5ii(p,m,n,o,e[g+7],10,1126891415),o=this.md5ii(o,p,m,n,e[g+14],15,-1416354905),n=this.md5ii(n,o,p,m,e[g+5],21,-57434055),m=this.md5ii(m,n,o,p,e[g+12],6,1700485571),p=this.md5ii(p,m,n,o,e[g+3],10,-1894986606),o=this.md5ii(o,p,m,n,e[g+10],15,-1051523),n=this.md5ii(n,o,p,m,e[g+1],21,-2054922799),m=this.md5ii(m,n,o,p,e[g+8],6,1873313359),p=this.md5ii(p,m,n,o,e[g+15],10,-30611744),o=this.md5ii(o,p,m,n,e[g+6],15,-1560198380),n=this.md5ii(n,o,p,m,e[g+13],21,1309151649),m=this.md5ii(m,n,o,p,e[g+4],6,-145523070),p=this.md5ii(p,m,n,o,e[g+11],10,-1120210379),o=this.md5ii(o,p,m,n,e[g+2],15,718787259),n=this.md5ii(n,o,p,m,e[g+9],21,-343485551),m=this.safeAdd(m,h),n=this.safeAdd(n,j),o=this.safeAdd(o,k),p=this.safeAdd(p,l);return[m,n,o,p]},binl2rstr(a){var b,c="",d=32*a.length;for(b=0;b<d;b+=8)c+=String.fromCharCode(255&a[b>>5]>>>b%32);return c},rstr2binl(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;var d=8*a.length;for(b=0;b<d;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c},rstrMD5(a){return this.binl2rstr(this.binlMD5(this.rstr2binl(a),8*a.length))},rstrHMACMD5(a,b){var c,d,e=this.rstr2binl(a),f=[],g=[];for(f[15]=g[15]=void 0,16<e.length&&(e=this.binlMD5(e,8*a.length)),c=0;16>c;c+=1)f[c]=909522486^e[c],g[c]=1549556828^e[c];return d=this.binlMD5(f.concat(this.rstr2binl(b)),512+8*b.length),this.binl2rstr(this.binlMD5(g.concat(d),640))},rstr2hex(a){var b,c,d="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),d+="0123456789abcdef".charAt(15&b>>>4)+"0123456789abcdef".charAt(15&b);return d},str2rstrUTF8(a){return unescape(encodeURIComponent(a))},rawMD5(a){return this.rstrMD5(this.str2rstrUTF8(a))},hexMD5(a){return this.rstr2hex(this.rawMD5(a))},rawHMACMD5(a,b){return this.rstrHMACMD5(this.str2rstrUTF8(a),str2rstrUTF8(b))},hexHMACMD5(a,b){return this.rstr2hex(this.rawHMACMD5(a,b))},md5(a,b,c){return b?c?this.rawHMACMD5(b,a):this.hexHMACMD5(b,a):c?this.rawMD5(a):this.hexMD5(a)},getSig(a,b,c,d){var e=null,f=[];return Object.keys(a).sort().forEach(function(b){f.push(b+"="+a[b])}),"search"==c&&(e="/ws/place/v1/search?"+f.join("&")+b),"suggest"==c&&(e="/ws/place/v1/suggestion?"+f.join("&")+b),"reverseGeocoder"==c&&(e="/ws/geocoder/v1/?"+f.join("&")+b),"geocoder"==c&&(e="/ws/geocoder/v1/?"+f.join("&")+b),"getCityList"==c&&(e="/ws/district/v1/list?"+f.join("&")+b),"getDistrictByCityId"==c&&(e="/ws/district/v1/getchildren?"+f.join("&")+b),"calculateDistance"==c&&(e="/ws/distance/v1/?"+f.join("&")+b),"direction"==c&&(e="/ws/direction/v1/"+d+"?"+f.join("&")+b),e=this.md5(e),e},location2query(a){if("string"==typeof a)return a;for(var b,c="",e=0;e<a.length;e++)b=a[e],!c||(c+=";"),b.location&&(c=c+b.location.lat+","+b.location.lng),b.latitude&&b.longitude&&(c=c+b.latitude+","+b.longitude);return c},rad(a){return a*Math.PI/180},getEndLocation(a){for(var b=a.split(";"),c=[],d=0;d<b.length;d++)c.push({lat:parseFloat(b[d].split(",")[0]),lng:parseFloat(b[d].split(",")[1])});return c},getDistance(a,c,d,e){var f=Math.cos,g=Math.pow,h=Math.sin,i=this.rad(a),j=this.rad(d),k=this.rad(c)-this.rad(e),b=2*Math.asin(Math.sqrt(g(h((i-j)/2),2)+f(i)*f(j)*g(h(k/2),2)));return b*=EARTH_RADIUS,b=Math.round(1e4*b)/1e4,parseFloat(b.toFixed(0))},getWXLocation(a,b,c){wx.getLocation({type:"gcj02",success:a,fail:b,complete:c})},getLocationParam(a){if("string"==typeof a){var b=a.split(",");a=2===b.length?{latitude:a.split(",")[0],longitude:a.split(",")[1]}:{}}return a},polyfillParam(a){a.success=a.success||function(){},a.fail=a.fail||function(){},a.complete=a.complete||function(){}},checkParamKeyEmpty(a,b){if(!a[b]){var c=this.buildErrorConfig(ERROR_CONF.PARAM_ERR,ERROR_CONF.PARAM_ERR_MSG+b+"\u53C2\u6570\u683C\u5F0F\u6709\u8BEF");return a.fail(c),a.complete(c),!0}return!1},checkKeyword(a){return!this.checkParamKeyEmpty(a,"keyword")},checkLocation(a){var b=this.getLocationParam(a.location);if(!b||!b.latitude||!b.longitude){var c=this.buildErrorConfig(ERROR_CONF.PARAM_ERR,ERROR_CONF.PARAM_ERR_MSG+" location\u53C2\u6570\u683C\u5F0F\u6709\u8BEF");return a.fail(c),a.complete(c),!1}return!0},buildErrorConfig(a,b){return{status:a,message:b}},handleData(a,b,c){if("search"==c){for(var d=b.data,e=[],f=0;f<d.length;f++)e.push({id:d[f].id||null,title:d[f].title||null,latitude:d[f].location&&d[f].location.lat||null,longitude:d[f].location&&d[f].location.lng||null,address:d[f].address||null,category:d[f].category||null,tel:d[f].tel||null,adcode:d[f].ad_info&&d[f].ad_info.adcode||null,city:d[f].ad_info&&d[f].ad_info.city||null,district:d[f].ad_info&&d[f].ad_info.district||null,province:d[f].ad_info&&d[f].ad_info.province||null});a.success(b,{searchResult:d,searchSimplify:e})}else if("suggest"==c){for(var g=b.data,h=[],f=0;f<g.length;f++)h.push({adcode:g[f].adcode||null,address:g[f].address||null,category:g[f].category||null,city:g[f].city||null,district:g[f].district||null,id:g[f].id||null,latitude:g[f].location&&g[f].location.lat||null,longitude:g[f].location&&g[f].location.lng||null,province:g[f].province||null,title:g[f].title||null,type:g[f].type||null});a.success(b,{suggestResult:g,suggestSimplify:h})}else if("reverseGeocoder"==c){var j=b.result,k={address:j.address||null,latitude:j.location&&j.location.lat||null,longitude:j.location&&j.location.lng||null,adcode:j.ad_info&&j.ad_info.adcode||null,city:j.address_component&&j.address_component.city||null,district:j.address_component&&j.address_component.district||null,nation:j.address_component&&j.address_component.nation||null,province:j.address_component&&j.address_component.province||null,street:j.address_component&&j.address_component.street||null,street_number:j.address_component&&j.address_component.street_number||null,recommend:j.formatted_addresses&&j.formatted_addresses.recommend||null,rough:j.formatted_addresses&&j.formatted_addresses.rough||null};if(j.pois){for(var l=j.pois,m=[],f=0;f<l.length;f++)m.push({id:l[f].id||null,title:l[f].title||null,latitude:l[f].location&&l[f].location.lat||null,longitude:l[f].location&&l[f].location.lng||null,address:l[f].address||null,category:l[f].category||null,adcode:l[f].ad_info&&l[f].ad_info.adcode||null,city:l[f].ad_info&&l[f].ad_info.city||null,district:l[f].ad_info&&l[f].ad_info.district||null,province:l[f].ad_info&&l[f].ad_info.province||null});a.success(b,{reverseGeocoderResult:j,reverseGeocoderSimplify:k,pois:l,poisSimplify:m})}else a.success(b,{reverseGeocoderResult:j,reverseGeocoderSimplify:k})}else if("geocoder"==c){var n=b.result,o={title:n.title||null,latitude:n.location&&n.location.lat||null,longitude:n.location&&n.location.lng||null,adcode:n.ad_info&&n.ad_info.adcode||null,province:n.address_components&&n.address_components.province||null,city:n.address_components&&n.address_components.city||null,district:n.address_components&&n.address_components.district||null,street:n.address_components&&n.address_components.street||null,street_number:n.address_components&&n.address_components.street_number||null,level:n.level||null};a.success(b,{geocoderResult:n,geocoderSimplify:o})}else if("getCityList"==c){var p=b.result[0],q=b.result[1],r=b.result[2];a.success(b,{provinceResult:p,cityResult:q,districtResult:r})}else if("getDistrictByCityId"==c){var s=b.result[0];a.success(b,s)}else if("calculateDistance"==c){for(var t=b.result.elements,u=[],f=0;f<t.length;f++)u.push(t[f].distance);a.success(b,{calculateDistanceResult:t,distance:u})}else if("direction"==c){var v=b.result.routes;a.success(b,v)}else a.success(b)},buildWxRequestConfig(a,b,c){var d=this;return b.header={"content-type":"application/json"},b.method="GET",b.success=function(b){var e=b.data;0===e.status?d.handleData(a,e,c):a.fail(e)},b.fail=function(b){b.statusCode=ERROR_CONF.WX_ERR_CODE,a.fail(d.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,b.errMsg))},b.complete=function(b){var c=+b.statusCode;switch(c){case ERROR_CONF.WX_ERR_CODE:{a.complete(d.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,b.errMsg));break}case ERROR_CONF.WX_OK_CODE:{var e=b.data;0===e.status?a.complete(e):a.complete(d.buildErrorConfig(e.status,e.message));break}default:a.complete(d.buildErrorConfig(ERROR_CONF.SYSTEM_ERR,ERROR_CONF.SYSTEM_ERR_MSG));}},b},locationProcess(a,b,c,d){var e=this;if(c=c||function(b){b.statusCode=ERROR_CONF.WX_ERR_CODE,a.fail(e.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,b.errMsg))},d=d||function(b){b.statusCode==ERROR_CONF.WX_ERR_CODE&&a.complete(e.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,b.errMsg))},!a.location)e.getWXLocation(b,c,d);else if(e.checkLocation(a)){var f=Utils.getLocationParam(a.location);b(f)}}};class QQMapWX{constructor(a){if(!a.key)throw Error("key\u503C\u4E0D\u80FD\u4E3A\u7A7A");this.key=a.key}search(a){var b=this;if(a=a||{},Utils.polyfillParam(a),!!Utils.checkKeyword(a)){var c={keyword:a.keyword,orderby:a.orderby||"_distance",page_size:a.page_size||10,page_index:a.page_index||1,output:"json",key:b.key};a.address_format&&(c.address_format=a.address_format),a.filter&&(c.filter=a.filter);var d=a.distance||"1000",e=a.auto_extend||1,f=null,g=null;a.region&&(f=a.region),a.rectangle&&(g=a.rectangle);var h=function(b){f&&!g?(c.boundary="region("+f+","+e+","+b.latitude+","+b.longitude+")",a.sig&&(c.sig=Utils.getSig(c,a.sig,"search"))):g&&!f?(c.boundary="rectangle("+g+")",a.sig&&(c.sig=Utils.getSig(c,a.sig,"search"))):(c.boundary="nearby("+b.latitude+","+b.longitude+","+d+","+e+")",a.sig&&(c.sig=Utils.getSig(c,a.sig,"search"))),wx.request(Utils.buildWxRequestConfig(a,{url:URL_SEARCH,data:c},"search"))};Utils.locationProcess(a,h)}}getSuggestion(a){var b=this;if(a=a||{},Utils.polyfillParam(a),!!Utils.checkKeyword(a)){var c={keyword:a.keyword,region:a.region||"\u5168\u56FD",region_fix:a.region_fix||0,policy:a.policy||0,page_size:a.page_size||10,page_index:a.page_index||1,get_subpois:a.get_subpois||0,output:"json",key:b.key};if(a.address_format&&(c.address_format=a.address_format),a.filter&&(c.filter=a.filter),a.location){var d=function(b){c.location=b.latitude+","+b.longitude,a.sig&&(c.sig=Utils.getSig(c,a.sig,"suggest")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_SUGGESTION,data:c},"suggest"))};Utils.locationProcess(a,d)}else a.sig&&(c.sig=Utils.getSig(c,a.sig,"suggest")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_SUGGESTION,data:c},"suggest"))}}reverseGeocoder(a){var b=this;a=a||{},Utils.polyfillParam(a);var c={coord_type:a.coord_type||5,get_poi:a.get_poi||0,output:"json",key:b.key};a.poi_options&&(c.poi_options=a.poi_options);var d=function(b){c.location=b.latitude+","+b.longitude,a.sig&&(c.sig=Utils.getSig(c,a.sig,"reverseGeocoder")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_GET_GEOCODER,data:c},"reverseGeocoder"))};Utils.locationProcess(a,d)}geocoder(a){var b=this;if(a=a||{},Utils.polyfillParam(a),!Utils.checkParamKeyEmpty(a,"address")){var c={address:a.address,output:"json",key:b.key};a.region&&(c.region=a.region),a.sig&&(c.sig=Utils.getSig(c,a.sig,"geocoder")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_GET_GEOCODER,data:c},"geocoder"))}}getCityList(a){var b=this;a=a||{},Utils.polyfillParam(a);var c={output:"json",key:b.key};a.sig&&(c.sig=Utils.getSig(c,a.sig,"getCityList")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_CITY_LIST,data:c},"getCityList"))}getDistrictByCityId(a){var b=this;if(a=a||{},Utils.polyfillParam(a),!Utils.checkParamKeyEmpty(a,"id")){var c={id:a.id||"",output:"json",key:b.key};a.sig&&(c.sig=Utils.getSig(c,a.sig,"getDistrictByCityId")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_AREA_LIST,data:c},"getDistrictByCityId"))}}calculateDistance(a){var b=this;if(a=a||{},Utils.polyfillParam(a),!Utils.checkParamKeyEmpty(a,"to")){var c={mode:a.mode||"walking",to:Utils.location2query(a.to),output:"json",key:b.key};if(a.from&&(a.location=a.from),"straight"==c.mode){var d=function(b){for(var d=Utils.getEndLocation(c.to),e={message:"query ok",result:{elements:[]},status:0},f=0;f<d.length;f++)e.result.elements.push({distance:Utils.getDistance(b.latitude,b.longitude,d[f].lat,d[f].lng),duration:0,from:{lat:b.latitude,lng:b.longitude},to:{lat:d[f].lat,lng:d[f].lng}});for(var g=e.result.elements,h=[],f=0;f<g.length;f++)h.push(g[f].distance);return a.success(e,{calculateResult:g,distanceResult:h})};Utils.locationProcess(a,d)}else{var d=function(b){c.from=b.latitude+","+b.longitude,a.sig&&(c.sig=Utils.getSig(c,a.sig,"calculateDistance")),wx.request(Utils.buildWxRequestConfig(a,{url:URL_DISTANCE,data:c},"calculateDistance"))};Utils.locationProcess(a,d)}}}direction(a){var b=this;if(a=a||{},Utils.polyfillParam(a),!Utils.checkParamKeyEmpty(a,"to")){var c={output:"json",key:b.key};c.to="string"==typeof a.to?a.to:a.to.latitude+","+a.to.longitude;var d=null;a.mode=a.mode||MODE.driving,d=URL_DIRECTION+a.mode,a.from&&(a.location=a.from),a.mode==MODE.driving&&(a.from_poi&&(c.from_poi=a.from_poi),a.heading&&(c.heading=a.heading),a.speed&&(c.speed=a.speed),a.accuracy&&(c.accuracy=a.accuracy),a.road_type&&(c.road_type=a.road_type),a.to_poi&&(c.to_poi=a.to_poi),a.from_track&&(c.from_track=a.from_track),a.waypoints&&(c.waypoints=a.waypoints),a.policy&&(c.policy=a.policy),a.plate_number&&(c.plate_number=a.plate_number)),a.mode==MODE.transit&&(a.departure_time&&(c.departure_time=a.departure_time),a.policy&&(c.policy=a.policy));var e=function(b){c.from=b.latitude+","+b.longitude,a.sig&&(c.sig=Utils.getSig(c,a.sig,"direction",a.mode)),wx.request(Utils.buildWxRequestConfig(a,{url:d,data:c},"direction"))};Utils.locationProcess(a,e)}}}module.exports=QQMapWX;